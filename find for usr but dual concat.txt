-- database: c:\Users\hutri\Documents\Matcha_ultra_v2\database.sqlite
-- Use the â–· button in the top right corner to run the entire file.
SELECT
    u.id,
    u.username,
    u.biography,
    u.gender,
    u.birthDate,
    u.orientation,
    u.latitude,
    u.longitude,
    u.age,
    d.distance,
    interests,
    image_srcs
FROM
    users AS u
    LEFT JOIN (
        SELECT
            user_id,
            GROUP_CONCAT(interest, ',') AS interests
        FROM
            user_interests
            JOIN interests ON user_interests.interest_id = interests.id
        GROUP BY
            user_id
    ) AS u_i ON u.id = u_i.user_id
    LEFT JOIN (
        SELECT
            user_id,
            GROUP_CONCAT(src, ',') AS image_srcs
        FROM
            pictures
        GROUP BY
            user_id
    ) AS p ON u.id = p.user_id
    INNER JOIN (
        SELECT
            id,
            (
                6371 * acos(
                    cos(radians(48.8566)) * cos(radians(latitude)) * cos(radians(longitude) - radians(2.3522)) + sin(radians(48.8566)) * sin(radians(latitude))
                )
            ) AS distance
        FROM
            users
    ) AS d ON u.id = d.id
WHERE
    d.distance < 500
    AND u.age <= 35
    AND u.age >= 18
    AND u.gender IN ("Male", "Female")
ORDER BY
    d.distance ASC
LIMIT
    10
OFFSET
    0;
